<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    x:Class="HouseApp.Views.ChatPage"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:viewModels="clr-namespace:HouseApp.ViewModels"
    xmlns:converters="clr-namespace:HouseApp.Converters"
    x:DataType="viewModels:ChatViewModel"
    Title="Chat"
    BackgroundColor="{StaticResource AppBg}">

    <ContentPage.Resources>
        <ResourceDictionary>
            <converters:BoolToColorConverter x:Key="BoolToColorConverter" />
            <converters:BoolToObjectConverter x:Key="BoolToObjectConverter" />
            <converters:BoolToMessageBackgroundConverter x:Key="BoolToMessageBackgroundConverter" />
            <converters:BoolToMessageBorderConverter x:Key="BoolToMessageBorderConverter" />
        </ResourceDictionary>
    </ContentPage.Resources>

    <Grid RowDefinitions="Auto,Auto,*,Auto" Padding="20" RowSpacing="14">

        <!-- Connection Status Indicator -->
        <Frame Grid.Row="0" 
               BackgroundColor="{StaticResource AccentLight}" 
               Padding="8" 
               CornerRadius="12"
               HasShadow="False"
               BorderColor="{StaticResource AccentBorder}">
            <HorizontalStackLayout Spacing="8">
                <BoxView WidthRequest="8" 
                         HeightRequest="8" 
                         CornerRadius="4"
                         VerticalOptions="Center"
                         BackgroundColor="{Binding IsConnected, Converter={StaticResource BoolToColorConverter}}" />
                <Label Text="{Binding ConnectionStatus}" 
                       FontSize="12"
                       TextColor="{StaticResource TextPrimary}"
                       VerticalOptions="Center" />
            </HorizontalStackLayout>
        </Frame>

        <!-- Header -->
        <Frame Grid.Row="1"
               CornerRadius="18"
               HasShadow="True"
               Padding="14"
               BackgroundColor="{StaticResource CardBg}">
            <Grid ColumnDefinitions="*,Auto" RowDefinitions="Auto,Auto" ColumnSpacing="12">
                <VerticalStackLayout Spacing="2">
                    <Label Text="House Chat"
                           FontSize="22"
                           FontAttributes="Bold"
                           TextColor="{StaticResource TextPrimary}" />
                    <Label Text="3 members • last message today"
                           FontSize="12"
                           TextColor="{StaticResource TextMuted}" />
                </VerticalStackLayout>

                <!-- Avatars (placeholder) -->
                <HorizontalStackLayout Grid.Column="1" Spacing="6" VerticalOptions="Center">
                    <Frame WidthRequest="28" HeightRequest="28" CornerRadius="14"
                           BackgroundColor="{StaticResource AccentLight}"
                           BorderColor="{StaticResource AccentBorder}"
                           HasShadow="False" />
                    <Frame WidthRequest="28" HeightRequest="28" CornerRadius="14"
                           BackgroundColor="#F3F4F6"
                           BorderColor="{StaticResource Border}"
                           HasShadow="False" />
                    <Frame WidthRequest="28" HeightRequest="28" CornerRadius="14"
                           BackgroundColor="#F3F4F6"
                           BorderColor="{StaticResource Border}"
                           HasShadow="False" />
                </HorizontalStackLayout>
            </Grid>
        </Frame>

        <!-- Messages -->
        <ScrollView Grid.Row="2">
            <VerticalStackLayout Spacing="12">
				
				<!-- Today separator chip -->
				<HorizontalStackLayout HorizontalOptions="Center" Margin="0,4,0,2">
					<Frame CornerRadius="14"
						   Padding="12,6"
						   BackgroundColor="{StaticResource AccentLight}"
						   BorderColor="{StaticResource AccentBorder}"
						   HasShadow="False">
						<Label Text="Today"
							   FontSize="12"
							   FontAttributes="Bold"
							   TextColor="{StaticResource Accent}" />
					</Frame>
				</HorizontalStackLayout>

                <!-- Dynamic messages from ViewModel -->
                <CollectionView ItemsSource="{Binding Messages}">
                    <CollectionView.ItemTemplate>
                        <DataTemplate>
                            <VerticalStackLayout Spacing="4" 
                                                 Padding="0,4"
                                                 HorizontalOptions="{Binding IsCurrentUser, Converter={StaticResource BoolToObjectConverter}, ConverterParameter='End|Start'}" 
                                                 WidthRequest="320">
                                <Label Text="{Binding SenderName}"
                                       FontSize="12"
                                       TextColor="{StaticResource TextMuted}"
                                       HorizontalOptions="{Binding IsCurrentUser, Converter={StaticResource BoolToObjectConverter}, ConverterParameter='End|Start'}" />
                                <Frame CornerRadius="16"
                                       Padding="12"
                                       BackgroundColor="{Binding IsCurrentUser, Converter={StaticResource BoolToMessageBackgroundConverter}}"
                                       BorderColor="{Binding IsCurrentUser, Converter={StaticResource BoolToMessageBorderConverter}}"
                                       HasShadow="False">
                                    <VerticalStackLayout Spacing="6">
                                        <Label Text="{Binding MessageText}"
                                               FontSize="14"
                                               TextColor="{StaticResource TextPrimary}" />
                                        <Label Text="{Binding Timestamp, StringFormat='{0:HH:mm}'}"
                                               FontSize="10"
                                               TextColor="{StaticResource TextMuted}"
                                               HorizontalOptions="End" />
                                    </VerticalStackLayout>
                                </Frame>
                            </VerticalStackLayout>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                </CollectionView>

                <!-- Spacer so last bubble doesn't hide behind input -->
                <BoxView HeightRequest="10" Opacity="0" />
            </VerticalStackLayout>
        </ScrollView>

        <!-- Input Bar -->
        <Grid Grid.Row="3" ColumnDefinitions="*,Auto" ColumnSpacing="10">
            <Frame CornerRadius="18"
                   Padding="10"
                   BackgroundColor="{StaticResource CardBg}"
                   BorderColor="{StaticResource Border}"
                   HasShadow="False">
                <Entry Placeholder="Type a message…"
                       Text="{Binding MessageText}"
                       TextColor="{StaticResource TextPrimary}"
                       PlaceholderColor="{StaticResource TextMuted}"
                       ReturnCommand="{Binding SendMessageCommand}" />
            </Frame>

            <Frame Grid.Column="1"
                   WidthRequest="54"
                   HeightRequest="54"
                   CornerRadius="18"
                   BackgroundColor="{StaticResource Accent}"
                   HasShadow="False"
                   IsEnabled="{Binding IsConnected}">
                <Frame.GestureRecognizers>
                    <TapGestureRecognizer Command="{Binding SendMessageCommand}" />
                </Frame.GestureRecognizers>
                <Label Text="➤"
                       FontSize="18"
                       TextColor="White"
                       HorizontalOptions="Center"
                       VerticalOptions="Center" />
            </Frame>
        </Grid>

    </Grid>
</ContentPage>
